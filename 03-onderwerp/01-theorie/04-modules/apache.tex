\subsection{Apache}
Als eerste voorbeeld een Apache module:
%
\begin{code}
\begin{lstlisting}
Apache
+--manifests
|	+--config.pp
|	+--init.pp
|	+--mod-php.pp
|	+--packages.pp
|	+--passenger.pp
|	+--prefork.pp
|	+--xsendfile.pp
|
+--templates
	+--httpd.conf.erb
\end{lstlisting}
\end{code}
%
Dit is de basis mapstructuur voor deze module. Een aantal van de bestanden in de manifests map zijn niet strict noodzakelijk, maar vormen een mooie uitbreiding op het standaardaanbod aan ingebouwde modules voor Apache. We zullen nu per bestand bekijken wat er juist gebeurd, we doen dit niet op alfabetische volgorde maar op de volgorde die puppet normaal gezien ook zal volgen.
%
\subsubsection{init.pp}
Als eerste manifest hebben we 'init.pp'. Dit is het eerste manifest dat puppet zal uitlezen en waarin je normaal gezien alle onderdelen gerust kan onderbrengen. In dit geval word het echter enkel gebruikt om de overige bestanden te laden, ook al is dit niet strict noodzakelijk. Als alles meezit zal puppet zelf de andere bestanden herkennen en ze includeren, indien puppet dit niet doet door bijvoorbeeld een systeemfout, een foute configuratie of een (zeer) verouderde versie van puppet, gebruiken we dit bestand om de anderen te includeren.
\begin{code}
\begin{lstlisting}
include *.pp
\end{lstlisting}
\end{code}
%
\subsubsection{packages.pp}
Als tweede manifest hebben we packages.pp. zoals je ziet noemt de class die dit manifest bevat 'apache::packages' en dus niet gewoon 'packages' zoals je zou verwachten. Dit verwijst naar de modulenaam (apache) met als subclass daarvan 'packages'. Indien je je classes op deze manier defini\"eert zal puppet met zijn 'auto lookup magic' de classes vinden en automatisch includeren.\\\\
Allereerst zorgen we ervoor dat het pakket 'apache' ge\"installeerd is. De naam die we gebruiken om het pakket te installeren is afhankelijk van een variabele, die een verschillende naam zal doorgeven afhankelijk van de distributie waarop puppet het manifest uitvoert. In dit geval zijn de keuzemogelijkheden 'apache2' of 'httpd' indien we een distributie vinden die overeenkomt met een van de genoemden. Indien dit niet zo is zal puppet terugvallen op de naam die voorzien word door 'Default'. Er is uiteraard geen garantie dat deze van toepassing zal zijn op het huidige systeem, maar het biedt wel de mogelijkheid om bijvoorbeeld een standaardwaarde mee te geven.
\begin{code}
\begin{lstlisting}[tabsize=4]
class apache::packages {
	package { apache:
		ensure => installed,
		name => $operatingsystem ? {
			/Debian|Ubuntu/ => 'apache2',
			/Centos|Fedora/ => 'httpd',
			Default => 'apache',
		},
	}
\end{lstlisting}
\end{code}
%
Hier zorgen we dat de service met als alias 'apache\_daemon' draait en dat deze gestart wordt als de machine opstart. Wederom zien we een aparte naam voor de service per distributie. Ditmaal voegen we ook een 'require' toe, waardoor puppet ervoor zorgt dat de apache service pas gestart zal worden nadat het pakket ge\"installeerd is.
%
\begin{code}
\begin{lstlisting}
	service { apache_daemon:
		ensure => running,
		enable => true,
		name => $operatingsystem ? {
			/Debian|Ubuntu/ => 'apache2',
			/Centos|Fedora/ => 'httpd',
		},
		require => Package['apache'],
	}
\end{lstlisting}
\end{code}
%
Als laatste zien we nog een 'package' object staan. Deze package is niet strict noodzakelijk maar wordt veelal gebruikt voor het integreren van andere packages met apache. Aangezien dit vaak voorkomt voegen we deze ook toe in de basisinstallatie.
%
\begin{code}
\begin{lstlisting}
	package { 'apache-dev':
		ensure => installed,
		name => $operatingsystem ? {
			/Debian|Ubuntu/ => 'apache2-threaded-dev',
			/Centos|Fedora/ => 'httpd-devel',
		},
	}
}
\end{lstlisting}
\end{code}
%\subsubsection{config.pp}
Deze manifest wordt gebruikt voor de configuratie van het apache pakket. In weze is dit slechts een voorbeeld om te laten zien hoe de configuratie verloopt, de echte configuratie zal normaal gezien gebeuren per project, eventueel op basis van dit bestand.
%
\begin{code}
\begin{lstlisting}
class apache::config {
	file { 'apache.conf':
		ensure => present,
		owner => root,
		group => root,
		mode => 0644,
		name => $operatingsystem ? {
			/Debian|Ubuntu/ => '/etc/apache2/apache2.conf',
			/Centos|Fedora/ => '/etc/httpd/conf/httpd.conf',
		},
		content => template('apache/httpd.conf'),
		notify => Service['apache'],
	}
}
\end{lstlisting}
\end{code}
%
Zoals je ziet wordt de configuratie gedaan via \'e\'en enkel bestand, dat afhankelijk van het besturingssysteem op een andere plaats te vinden is. We zorgen met deze definitie dat het bestand aanwezig is, zowel als eigenaar als groep aan 'root' toebehoort en als mode '0644' meekrijgt. Het effectieve bestand halen we uit de template map van de apache module en heet 'httpd.conf'. Tot slot zorgen we ervoor dat de service 'apache' wordt herstart telkens er een wijziging aan dit bestand wordt aangebracht.
%
\subsubsection{httpd.conf}
Dit is een template, geschikt om te dienen als basis apache configuratie bestand. Op sommige plaatsen zie je '<\%= variabelenaam \%>' constructs staan, dit zijn variabelen die je kan doorgeven via je manifest.
\begin{code}
\begin{lstlisting}
ServerTokens OS

ServerRoot "/etc/httpd"

PidFile run/httpd.pid

Timeout 60

KeepAlive Off

MaxKeepAliveRequests 100

KeepAliveTimeout 5

<IfModule prefork.c>
StartServers       8
MinSpareServers    5
MaxSpareServers   20
ServerLimit      256
MaxClients       256
MaxRequestsPerChild  4000
</IfModule>

<IfModule worker.c>
StartServers         4
MaxClients         300
MinSpareThreads     25
MaxSpareThreads     75 
ThreadsPerChild     25
MaxRequestsPerChild  0
</IfModule>

Listen 80

LoadModule auth_basic_module modules/mod_auth_basic.so
LoadModule auth_digest_module modules/mod_auth_digest.so
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authn_alias_module modules/mod_authn_alias.so
LoadModule authn_anon_module modules/mod_authn_anon.so
LoadModule authn_dbm_module modules/mod_authn_dbm.so
LoadModule authn_default_module modules/mod_authn_default.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule authz_user_module modules/mod_authz_user.so
LoadModule authz_owner_module modules/mod_authz_owner.so
LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
LoadModule authz_dbm_module modules/mod_authz_dbm.so
LoadModule authz_default_module modules/mod_authz_default.so
LoadModule ldap_module modules/mod_ldap.so
LoadModule authnz_ldap_module modules/mod_authnz_ldap.so
LoadModule include_module modules/mod_include.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule logio_module modules/mod_logio.so
LoadModule env_module modules/mod_env.so
LoadModule ext_filter_module modules/mod_ext_filter.so
LoadModule mime_magic_module modules/mod_mime_magic.so
LoadModule expires_module modules/mod_expires.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule headers_module modules/mod_headers.so
LoadModule usertrack_module modules/mod_usertrack.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule mime_module modules/mod_mime.so
LoadModule dav_module modules/mod_dav.so
LoadModule status_module modules/mod_status.so
LoadModule autoindex_module modules/mod_autoindex.so
LoadModule info_module modules/mod_info.so
LoadModule dav_fs_module modules/mod_dav_fs.so
LoadModule vhost_alias_module modules/mod_vhost_alias.so
LoadModule negotiation_module modules/mod_negotiation.so
LoadModule dir_module modules/mod_dir.so
LoadModule actions_module modules/mod_actions.so
LoadModule speling_module modules/mod_speling.so
LoadModule userdir_module modules/mod_userdir.so
LoadModule alias_module modules/mod_alias.so
LoadModule substitute_module modules/mod_substitute.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule proxy_ftp_module modules/mod_proxy_ftp.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_ajp_module modules/mod_proxy_ajp.so
LoadModule proxy_connect_module modules/mod_proxy_connect.so
LoadModule cache_module modules/mod_cache.so
LoadModule suexec_module modules/mod_suexec.so
LoadModule disk_cache_module modules/mod_disk_cache.so
LoadModule cgi_module modules/mod_cgi.so
LoadModule version_module modules/mod_version.so

Include conf.d/*.conf

User apache
Group apache

ServerAdmin root@localhost

UseCanonicalName Off

DocumentRoot "/var/www/html"

<Directory />
    Options FollowSymLinks
    AllowOverride None
</Directory>


<Directory "/var/www/html">
    Options Indexes FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
</Directory>

<IfModule mod_userdir.c>
</IfModule>

DirectoryIndex index.html index.html.var

AccessFileName .htaccess

<Files ~ "^\.ht">
    Order allow,deny
    Deny from all
    Satisfy All
</Files>

TypesConfig /etc/mime.types

DefaultType text/plain

<IfModule mod_mime_magic.c>
    MIMEMagicFile conf/magic
</IfModule>

HostnameLookups Off

ErrorLog logs/error_log

LogLevel warn

LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent

CustomLog logs/access_log combined

ServerSignature On

Alias /icons/ "/var/www/icons/"

<Directory "/var/www/icons">
    Options Indexes MultiViews FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
</Directory>

<IfModule mod_dav_fs.c>
    # Location of the WebDAV lock database.
    DAVLockDB /var/lib/dav/lockdb
</IfModule>

ScriptAlias /cgi-bin/ "/var/www/cgi-bin/"

<Directory "/var/www/cgi-bin">
    AllowOverride None
    Options None
    Order allow,deny
    Allow from all
</Directory>

IndexOptions FancyIndexing VersionSort NameWidth=* HTMLTable Charset=UTF-8

AddIconByEncoding (CMP,/icons/compressed.gif) x-compress x-gzip
AddIconByType (TXT,/icons/text.gif) text/*
AddIconByType (IMG,/icons/image2.gif) image/*
AddIconByType (SND,/icons/sound2.gif) audio/*
AddIconByType (VID,/icons/movie.gif) video/*
AddIcon /icons/binary.gif .bin .exe
AddIcon /icons/binhex.gif .hqx
AddIcon /icons/tar.gif .tar
AddIcon /icons/world2.gif .wrl .wrl.gz .vrml .vrm .iv
AddIcon /icons/compressed.gif .Z .z .tgz .gz .zip
AddIcon /icons/a.gif .ps .ai .eps
AddIcon /icons/layout.gif .html .shtml .htm .pdf
AddIcon /icons/text.gif .txt
AddIcon /icons/c.gif .c
AddIcon /icons/p.gif .pl .py
AddIcon /icons/f.gif .for
AddIcon /icons/dvi.gif .dvi
AddIcon /icons/uuencoded.gif .uu
AddIcon /icons/script.gif .conf .sh .shar .csh .ksh .tcl
AddIcon /icons/tex.gif .tex
AddIcon /icons/bomb.gif core
AddIcon /icons/back.gif ..
AddIcon /icons/hand.right.gif README
AddIcon /icons/folder.gif ^^DIRECTORY^^
AddIcon /icons/blank.gif ^^BLANKICON^^

DefaultIcon /icons/unknown.gif

ReadmeName README.html
HeaderName HEADER.html

IndexIgnore .??* *~ *# HEADER* README* RCS CVS *,v *,t

AddLanguage ca .ca
AddLanguage cs .cz .cs
AddLanguage da .dk
AddLanguage de .de
AddLanguage el .el
AddLanguage en .en
AddLanguage eo .eo
AddLanguage es .es
AddLanguage et .et
AddLanguage fr .fr
AddLanguage he .he
AddLanguage hr .hr
AddLanguage it .it
AddLanguage ja .ja
AddLanguage ko .ko
AddLanguage ltz .ltz
AddLanguage nl .nl
AddLanguage nn .nn
AddLanguage no .no
AddLanguage pl .po
AddLanguage pt .pt
AddLanguage pt-BR .pt-br
AddLanguage ru .ru
AddLanguage sv .sv
AddLanguage zh-CN .zh-cn
AddLanguage zh-TW .zh-tw
LanguagePriority en ca cs da de el eo es et fr he hr it ja ko ltz nl nn no pl pt pt-BR ru sv zh-CN zh-TW
ForceLanguagePriority Prefer Fallback

AddDefaultCharset UTF-8

AddType application/x-compress .Z
AddType application/x-gzip .gz .tgz
AddType application/x-x509-ca-cert .crt
AddType application/x-pkcs7-crl    .crl
AddHandler type-map var
AddType text/html .shtml
AddOutputFilter INCLUDES .shtml

Alias /error/ "/var/www/error/"

<IfModule mod_negotiation.c>
<IfModule mod_include.c>
    <Directory "/var/www/error">
        AllowOverride None
        Options IncludesNoExec
        AddOutputFilter Includes html
        AddHandler type-map var
        Order allow,deny
        Allow from all
        LanguagePriority en es de fr
        ForceLanguagePriority Prefer Fallback
    </Directory>
</IfModule>
</IfModule>
BrowserMatch "Mozilla/2" nokeepalive
BrowserMatch "MSIE 4\.0b2;" nokeepalive downgrade-1.0 force-response-1.0
BrowserMatch "RealPlayer 4\.0" force-response-1.0
BrowserMatch "Java/1\.0" force-response-1.0
BrowserMatch "JDK/1\.0" force-response-1.0
BrowserMatch "Microsoft Data Access Internet Publishing Provider" redirect-carefully
BrowserMatch "MS FrontPage" redirect-carefully
BrowserMatch "^WebDrive" redirect-carefully
BrowserMatch "^WebDAVFS/1.[0123]" redirect-carefully
BrowserMatch "^gnome-vfs/1.0" redirect-carefully
BrowserMatch "^XML Spy" redirect-carefully
BrowserMatch "^Dreamweaver-WebDAV-SCM1" redirect-carefully
\end{lstlisting}
\end{code}
